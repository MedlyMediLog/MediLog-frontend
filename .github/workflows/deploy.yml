name: Deploy Frontend to EC2

on:
  push:
    branches: [main] # dev로 배포하려면 main -> dev로 바꿔

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on EC2 via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}   # ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 45m
          script: |
            set -euo pipefail

            echo "=== $(date) : START ==="
            whoami
            hostname
            pwd

            echo "=== $(date) : NODE CHECK / ENSURE v20 ==="
            node -v || true
            npm -v || true

            if ! node -v 2>/dev/null | grep -q "^v20\."; then
              echo "[DEPLOY] Installing Node 20..."
              sudo apt update -y
              sudo apt remove -y nodejs || true
              sudo apt autoremove -y || true
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt install -y nodejs
            fi

            node -v
            npm -v

            echo "=== $(date) : PREPARE REPO ==="
            if [ ! -d "$HOME/MediLog-frontend/.git" ]; then
              cd ~
              rm -rf MediLog-frontend
              git clone https://github.com/MedlyMediLog/MediLog-frontend.git
            fi

            cd ~/MediLog-frontend

            echo "=== $(date) : GIT SYNC ==="
            git fetch origin main
            git reset --hard origin/main
            git clean -fd
            git rev-parse --short HEAD

            echo "=== $(date) : INSTALL ==="
            npm config set fund false
            npm config set audit false

            if [ -f package-lock.json ]; then
              npm ci --no-progress
            else
              npm install --no-progress
            fi

            echo "=== $(date) : BUILD ==="
            export CI=true
            export NEXT_TELEMETRY_DISABLED=1
            npm run build

            echo "=== $(date) : PM2 RESTART ==="
            if ! command -v pm2 >/dev/null 2>&1; then
              sudo npm i -g pm2
            fi

            pm2 restart medilog-front || pm2 start npm --name "medilog-front" -- start
            pm2 save

            echo "=== $(date) : DONE ==="
